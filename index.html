<!DOCTYPE html>
<html>
<head>
  <title>My WMATA Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .stop { margin-bottom: 20px; }
    .stop h2 { margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>My WMATA Tracker</h1>

  <!-- Input for dynamic bus stop lookup -->
  <div>
    <h2>Check Another Bus Stop</h2>
    <input type="text" id="dynamicStopId" placeholder="Enter bus stop ID" />
    <button id="checkStopBtn">Check</button>
    <div id="dynamicStopResults"></div>
  </div>

  <div id="busContainer"></div>
  <div id="railContainer"></div>

  <script>
    const apiKey = "1b71cc7c2d6049e9b06fbbd7b81c24e4";

    const busStops = [
      { id: "1001191", name: "14th St & I St NW" },
      { id: "1002905", name: "16th St NW & Colorado" },
      { id: "1002906", name: "16th St NW & Blagden" },
      { id: "1002514", name: "16th St NW & Emerson" }
    ];

    const railLines = ["RD", "OR", "BL", "GR", "SV"];
    const railStations = [
      { code: "A01", name: "Metro Center" },
      { code: "E06", name: "Fort Totten" },
      { code: "B06", name: "Fort Totten" }
    ];

    async function fetchBus(stop) {
      const url = `https://api.wmata.com/NextBusService.svc/json/jPredictions?StopID=${stop.id}`;
      const resp = await fetch(url, { headers: { "api_key": apiKey } });
      return resp.json();
    }

    async function fetchRail(station) {
      const url = `https://api.wmata.com/StationPrediction.svc/json/GetPrediction/${station.code}`;
      const resp = await fetch(url, { headers: { "api_key": apiKey } });
      return resp.json();
    }

    async function loadData() {
      const busContainer = document.getElementById("busContainer");
      const railContainer = document.getElementById("railContainer");

      busContainer.innerHTML = "<h2>Bus Predictions</h2>";
      railContainer.innerHTML = "<h2>Rail Predictions</h2>";

      // --- Buses ---
      for (let stop of busStops) {
        const data = await fetchBus(stop);
        const div = document.createElement("div");
        div.className = "stop";
        div.innerHTML = `<h3>${stop.name}</h3>`;
        if (!data.Predictions || data.Predictions.length === 0) {
          div.innerHTML += "<p>No upcoming buses</p>";
        } else {
          const upcoming = data.Predictions.filter(p => p.Minutes <= 15);
          if (upcoming.length === 0) {
            div.innerHTML += "<p>No buses arriving within 15 minutes</p>";
          } else {
            div.innerHTML += "<ul>" + upcoming.map(p =>
              `<li>${p.RouteID} to ${p.DirectionText}: ${p.Minutes} min</li>`
            ).join("") + "</ul>";
          }
        }
        busContainer.appendChild(div);
      }

      // --- Rail ---
      for (let station of railStations) {
        const data = await fetchRail(station);
        const div = document.createElement("div");
        div.className = "stop";
        div.innerHTML = `<h3>${station.name}</h3>`;

        railLines.forEach(lineCode => {
          const lineTrains = data.Trains.filter(t => {
            if (t.Line !== lineCode) return false;
            if (!t.Min) return false;
            const min = t.Min === "ARR" ? 0 : parseInt(t.Min, 10);
            return min <= 15;
          });

          if (lineTrains.length === 0) {
            //div.innerHTML += `<p>${lineCode} line: no trains within 15 minutes</p>`;
          } else {
            div.innerHTML += "<ul>" + lineTrains.map(t => {
              const min = t.Min === "ARR" ? "Arriving" : t.Min + " min";
              return `<li>${t.Line} line to ${t.DestinationName}: ${min}</li>`;
            }).join("") + "</ul>";
          }
        });

        railContainer.appendChild(div);
      }
    }

    // --- Dynamic bus stop check ---
    document.getElementById("checkStopBtn").addEventListener("click", async () => {
      const stopId = document.getElementById("dynamicStopId").value.trim();
      if (!stopId) return;

      const container = document.getElementById("dynamicStopResults");
      container.innerHTML = `<h3>Stop ${stopId}</h3>`;

      try {
        const data = await fetchBus({ id: stopId });
        if (!data.Predictions || data.Predictions.length === 0) {
          container.innerHTML += "<p>No upcoming buses</p>";
        } else {
          const upcoming = data.Predictions.filter(p => p.Minutes <= 15);
          if (upcoming.length === 0) {
            container.innerHTML += "<p>No buses arriving within 15 minutes</p>";
          } else {
            container.innerHTML += "<ul>" + upcoming.map(p =>
              `<li>${p.RouteID} to ${p.DirectionText}: ${p.Minutes} min</li>`
            ).join("") + "</ul>";
          }
        }
      } catch (e) {
        container.innerHTML += `<p>Error fetching data: ${e}</p>`;
      }
    });

    loadData();
  </script>
</body>
</html>
